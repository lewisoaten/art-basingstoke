<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta aframe-injected="" name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,shrink-to-fit=no,user-scalable=no,minimal-ui">
  <meta aframe-injected="" name="mobile-web-app-capable" content="yes">
  <meta description="ARt Basingstoke exploring art in unusual spaces with Augmented Reality.">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@lewisoaten" />
  <meta name="twitter:title" content="ARt Basingstoke" />
  <meta name="twitter:description" content="ARt Basingstoke exploring art in unusual spaces with Augmented Reality."
  />
  <meta name="twitter:image" content="https://github.com/lewisoaten/art-basingstoke" />

  <title>
    ARt Basingstoke - Art in unusual spaces with Augmented Reality
  </title>

  <link rel="stylesheet" type="text/css" href="./styles/style.css" />
  <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Open+Sans" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

  <script src="https://cdn.rawgit.com/jeromeetienne/AR.js/1.5.1/three.js/examples/vendor/three.js/build/three.min.js"></script>
  <script src="https://cdn.rawgit.com/jeromeetienne/AR.js/1.5.1/three.js/build/ar.js"></script>
  <script src="./scripts/artList.js"></script>
  <script src="./scripts/main.js"></script>
</head>

<body>
  <main class="main">
    <div id="header">
      <div id="header-content">
        <div>ARt Basingstoke</div>
      </div>
    </div>
    <div id="splashScreen" class="AR-tip" style="display:none">
      <p>Art in unusual spaces with Augmented Reality.
        <div>
          <a href="#" class="help" style="font-size:14px;">How it works?</a>
        </div>
        <div id="video_demo" class="demo" style="display:none">
          <iframe width="100%" height="240" src="https://www.youtube.com/"></iframe>
          <p style="font-size:1em; font-weight:600">Note: Scan the AR code markers</p>
        </div>
      </p>
      <div class="gotit btn custom-button">Start</div>
    </div>
    <div class="word-tip">
      <div class="title"></div>
    </div>

    <div class="btns-wrap">
      <div title="Previous" class="btn prev custom-button"></div>
      <div title="Next" class="btn next custom-button"></div>
    </div>
    <div class="AR-tip" id="noMedia" style="display:none">
    </div>
  </main>

  <script>
    //////////////////////////////////////////////////////////////////////////////////
    //		Init
    //////////////////////////////////////////////////////////////////////////////////
    // init renderer
    var trackingBackend = 'aruco';

    var renderer	= new THREE.WebGLRenderer({
    	antialias: true,
    	alpha: true
    });
    renderer.setClearColor(new THREE.Color('lightgrey'), 0)
    renderer.setSize( 640, 480 );
    renderer.domElement.style.position = 'absolute'
    renderer.domElement.style.top = '0px'
    renderer.domElement.style.left = '0px'
    document.body.appendChild( renderer.domElement );
    // array of functions for the rendering loop
    var onRenderFcts= [];
    // init scene and camera
    var scene	= new THREE.Scene();

    //////////////////////////////////////////////////////////////////////////////////
    //		Initialize a basic camera
    //////////////////////////////////////////////////////////////////////////////////
    // Create a camera
    if( trackingBackend === 'aruco' ){
      var camera = new THREE.PerspectiveCamera(42, renderer.domElement.width / renderer.domElement.height, 0.01, 100);
    }else if( trackingBackend === 'artoolkit' ){
      var camera = new THREE.Camera();
    }else console.assert(false)
    scene.add(camera);
    ////////////////////////////////////////////////////////////////////////////////
    //          handle arToolkitSource
    ////////////////////////////////////////////////////////////////////////////////
    var arToolkitSource = new THREEx.ArToolkitSource({
    	// to read from the webcam
    	sourceType : 'webcam',

    	// // to read from an image
    	// sourceType : 'image',
    	// sourceUrl : THREEx.ArToolkitContext.baseURL + '../data/images/img.jpg',
    	// to read from a video
    	// sourceType : 'video',
    	// sourceUrl : './assets/test_2_compress.mp4',
    })
    arToolkitSource.init(function onReady(){
    	onResize()
    })

    // handle resize
    window.addEventListener('resize', function(){
    	onResize()
    })
    function onResize(){
    	arToolkitSource.onResize()
    	arToolkitSource.copySizeTo(renderer.domElement)
      if( trackingBackend === 'aruco' ){
  			arToolkitSource.copyElementSizeTo(arToolkitContext.arucoContext.canvas)
  			camera.aspect = renderer.domElement.width / renderer.domElement.height;
  			camera.updateProjectionMatrix();
  		}else if( trackingBackend === 'artoolkit' ){
  			if( arToolkitContext.arController !== null ){
  				arToolkitSource.copyElementSizeTo(arToolkitContext.arController.canvas)
  			}
  		}else console.assert(false)
    }
    ////////////////////////////////////////////////////////////////////////////////
    //          initialize arToolkitContext
    ////////////////////////////////////////////////////////////////////////////////

    // create atToolkitContext
    var arToolkitContext = new THREEx.ArToolkitContext({
    	cameraParametersUrl: './assets/camera_para.dat',
    	detectionMode: 'mono_and_matrix',
      matrixCodeType: '3x3',
      trackingBackend: 'aruco',
      maxDetectionRate: 60,
    })
    // initialize it
    arToolkitContext.init(function onCompleted(){
    	// copy projection matrix to camera
      if( trackingBackend === 'artoolkit' ){
        camera.projectionMatrix.copy( arToolkitContext.getProjectionMatrix() );
      }
    })
    // update artoolkit on every frame
    onRenderFcts.push(function(){
    	if( arToolkitSource.ready === false )	return
    	arToolkitContext.update( arToolkitSource.domElement )

    	// update scene.visible if the marker is seen
    	scene.visible = camera.visible
    })

    ////////////////////////////////////////////////////////////////////////////////
    //          Create a ArMarkerControls
    ////////////////////////////////////////////////////////////////////////////////

    // init controls for camera
    var markerControls = new THREEx.ArMarkerControls(arToolkitContext, camera, {
    	type : 'barcode',
    	// patternUrl : './assets/patt.hiro',
      barcodeValue: 20,
    	// patternUrl : THREEx.ArToolkitContext.baseURL + '../data/data/patt.kanji',
    	// as we controls the camera, set changeMatrixMode: 'cameraTransformMatrix'
    	changeMatrixMode: 'cameraTransformMatrix'
    })
    // as we do changeMatrixMode: 'cameraTransformMatrix', start with invisible scene
    scene.visible = false
    //////////////////////////////////////////////////////////////////////////////////
    //		add an object in the scene
    //////////////////////////////////////////////////////////////////////////////////
    // add a torus knot
    var geometry	= new THREE.CubeGeometry(1,1,1);
    var material	= new THREE.MeshNormalMaterial({
    	transparent : true,
    	opacity: 0.5,
    	side: THREE.DoubleSide
    });
    var mesh	= new THREE.Mesh( geometry, material );
    mesh.position.y	= geometry.parameters.height/2
    scene.add( mesh );

    var geometry	= new THREE.TorusKnotGeometry(0.3,0.1,64,16);
    var material	= new THREE.MeshNormalMaterial();
    var mesh	= new THREE.Mesh( geometry, material );
    mesh.position.y	= 0.5
    scene.add( mesh );

    onRenderFcts.push(function(delta){
    	mesh.rotation.x += Math.PI*delta
    })
    //////////////////////////////////////////////////////////////////////////////////
    //		render the whole thing on the page
    //////////////////////////////////////////////////////////////////////////////////
    // render the scene
    onRenderFcts.push(function(){
    	renderer.render( scene, camera );
    })
    // run the rendering loop
    var lastTimeMsec= null
    requestAnimationFrame(function animate(nowMsec){
    	// keep looping
    	requestAnimationFrame( animate );
    	// measure time
    	lastTimeMsec	= lastTimeMsec || nowMsec-1000/60
    	var deltaMsec	= Math.min(200, nowMsec - lastTimeMsec)
    	lastTimeMsec	= nowMsec
    	// call each update function
    	onRenderFcts.forEach(function(onRenderFct){
    		onRenderFct(deltaMsec/1000, nowMsec/1000)
    	})
    })
  </script>

  <script async>
  if ('serviceWorker' in navigator) {
    console.log("Will the service worker register?");
    navigator.serviceWorker.register('scripts/service-worker.js')
      .then(function (reg) {
        console.log("Yes, it did.");
      }).catch(function (err) {
        console.log("No it didn't. This happened: ", err)
      });
  }
  </script>

  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-118805418-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-118805418-1');
  </script>
  <noscript>
    Javascript is required to run this app!
  </noscript>


</body>

</html>
