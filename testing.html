<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta aframe-injected="" name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,shrink-to-fit=no,user-scalable=no,minimal-ui">
  <meta aframe-injected="" name="mobile-web-app-capable" content="yes">
  <meta description="ARt Basingstoke exploring art in unusual spaces with Augmented Reality.">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@lewisoaten" />
  <meta name="twitter:title" content="ARt Basingstoke" />
  <meta name="twitter:description" content="ARt Basingstoke exploring art in unusual spaces with Augmented Reality."
  />
  <meta name="twitter:image" content="https://github.com/lewisoaten/art-basingstoke" />

  <title>
    ARt Basingstoke - Art in unusual spaces with Augmented Reality
  </title>

  <link rel="stylesheet" type="text/css" href="./styles/style.css" />
  <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Open+Sans" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

  <script src="https://cdn.rawgit.com/jeromeetienne/AR.js/1.5.1/three.js/examples/vendor/three.js/build/three.min.js"></script>
  <script src="https://cdn.rawgit.com/jeromeetienne/AR.js/1.5.1/three.js/build/ar.js"></script>
  <script src="./scripts/MTLLoader.js"></script>
  <script src="./scripts/OBJLoader.js"></script>
  <script src="./scripts/artList.js"></script>
  <script src="./scripts/main.js"></script>
</head>

<body>
  <main class="main">
    <div id="header">
      <div id="header-content">
        <div>ARt Basingstoke</div>
      </div>
    </div>
    <div id="splashScreen" class="AR-tip" style="display:none">
      <p>Art in unusual spaces with Augmented Reality.
        <div>
          <a href="#" class="help" style="font-size:14px;">How it works?</a>
        </div>
        <div id="video_demo" class="demo" style="display:none">
          <iframe width="100%" height="240" src="https://www.youtube.com/"></iframe>
          <p style="font-size:1em; font-weight:600">Note: Scan the AR code markers</p>
        </div>
      </p>
      <div class="gotit btn custom-button">Start</div>
    </div>
    <div class="word-tip">
      <div class="title">...</div>
    </div>

    <div class="btns-wrap">
      <div title="Previous" class="btn prev custom-button"></div>
      <div title="Next" class="btn next custom-button"></div>
    </div>
    <div class="AR-tip" id="noMedia" style="display:none">
    </div>
  </main>

  <script>
    //////////////////////////////////////////////////////////////////////////////////
    //		Init
    //////////////////////////////////////////////////////////////////////////////////
    // init renderer
    var trackingBackend = 'artoolkit'; // aruco or artoolkit

    var renderer	= new THREE.WebGLRenderer({
    	antialias: true,
    	alpha: true
    });
    renderer.setClearColor(new THREE.Color('lightgrey'), 0)
    renderer.setSize( 640, 480 );
    renderer.domElement.style.position = 'absolute'
    renderer.domElement.style.top = '0px'
    renderer.domElement.style.left = '0px'
    document.body.appendChild( renderer.domElement );
    // array of functions for the rendering loop
    var onRenderFcts= [];
    // init scene and camera
    var scene	= new THREE.Scene();

    //////////////////////////////////////////////////////////////////////////////////
    //		Initialize a basic camera
    //////////////////////////////////////////////////////////////////////////////////
    // Create a camera
    if( trackingBackend === 'aruco' ){
      var camera = new THREE.PerspectiveCamera(42, renderer.domElement.width / renderer.domElement.height, 0.01, 100);
    }else if( trackingBackend === 'artoolkit' ){
      var camera = new THREE.PerspectiveCamera(42, renderer.domElement.width / renderer.domElement.height, 0.01, 100);
    }else console.assert(false)

    var pointLight = new THREE.PointLight( 0xffffff, 0.8 );
    camera.add( pointLight );
    scene.add(camera);
    ////////////////////////////////////////////////////////////////////////////////
    //          handle arToolkitSource
    ////////////////////////////////////////////////////////////////////////////////
    var arToolkitSource = new THREEx.ArToolkitSource({
      // type of source - ['webcam', 'image', 'video']
    	sourceType : 'video',
    	// url of the source - valid if sourceType = image|video
    	sourceUrl : './assets/test_2_compress.mp4',

    	// resolution of at which we initialize the source image
    	// sourceWidth: 1280,
    	// sourceHeight: 720,
    	// resolution displayed for the source
    	// displayWidth: 640,
    	// displayHeight: 480,
    })
    arToolkitSource.init(function onReady(){
    	onResize()
    })

    // handle resize
    window.addEventListener('resize', function(){
    	onResize()
    })

    function onResize(){
    	arToolkitSource.onResize()
    	arToolkitSource.copySizeTo(renderer.domElement)
      if( trackingBackend === 'aruco' ){
  			arToolkitSource.copyElementSizeTo(arToolkitContext.arucoContext.canvas)
  			camera.aspect = renderer.domElement.width / renderer.domElement.height;
  			camera.updateProjectionMatrix();
  		}else if( trackingBackend === 'artoolkit' ){
  			if( arToolkitContext.arController !== null ){
  				arToolkitSource.copyElementSizeTo(arToolkitContext.arController.canvas)
  			}
  		}else console.assert(false)
    }
    ////////////////////////////////////////////////////////////////////////////////
    //          initialize arToolkitContext
    ////////////////////////////////////////////////////////////////////////////////

    // create atToolkitContext
    var arToolkitContext = new THREEx.ArToolkitContext({
      // debug - true if one should display artoolkit debug canvas, false otherwise
    	debug: false,
      // artoolkit, aruco, best
      trackingBackend: trackingBackend,
    	// the mode of detection - ['color', 'color_and_matrix', 'mono', 'mono_and_matrix']
    	detectionMode: 'color_and_matrix',
    	// type of matrix code - valid iif detectionMode end with 'matrix' - [3x3, 3x3_HAMMING63, 3x3_PARITY65, 4x4, 4x4_BCH_13_9_3, 4x4_BCH_13_5_5]
    	matrixCodeType: '3x3',

    	// url of the camera parameters
    	cameraParametersUrl: './assets/camera_para.dat',

    	// tune the maximum rate of pose detection in the source image
    	maxDetectionRate: 60,
    	// resolution of at which we detect pose in the source image
    	// canvasWidth: 640,
    	// canvasHeight: 480,

    	// enable image smoothing or not for canvas copy - default to true
    	// https://developer.mozilla.org/en-US/docs/Web/API/CanvasRenderingContext2D/imageSmoothingEnabled
    	imageSmoothingEnabled : true,
    })
    // initialize it
    arToolkitContext.init(function onCompleted(){
    	// copy projection matrix to camera
      if( trackingBackend === 'artoolkit' ){
        camera.projectionMatrix.copy( arToolkitContext.getProjectionMatrix() );
      }
    })
    // update artoolkit on every frame
    onRenderFcts.push(function(){
    	if( arToolkitSource.ready === false )	return
    	arToolkitContext.update( arToolkitSource.domElement )

    	// update scene.visible if the marker is seen
    	scene.visible = camera.visible
    })

    ////////////////////////////////////////////////////////////////////////////////
    //          Create a ArMarkerControls
    ////////////////////////////////////////////////////////////////////////////////

    var markerGroup = new THREE.Group
    scene.add(markerGroup)

    // init controls for camera // markerGroup for modelViewMatrix and camera for cameraTransformMatrix
    var markerControls = new THREEx.ArMarkerControls(arToolkitContext, markerGroup, {
      // size of the marker in meter
      size : 1,
      // type of marker - ['pattern', 'barcode', 'unknown' ]
      type : 'barcode',
      // url of the pattern - IIF type='pattern'
      patternUrl : null,
      // value of the barcode - IIF type='barcode'
      barcodeValue : 20,
      // change matrix mode - [modelViewMatrix, cameraTransformMatrix]
      changeMatrixMode : 'modelViewMatrix',
    })
    // as we do changeMatrixMode: 'cameraTransformMatrix', start with invisible scene
    scene.visible = false
    //////////////////////////////////////////////////////////////////////////////////
    //		add an object in the scene
    //////////////////////////////////////////////////////////////////////////////////

    var markerScene = new THREE.Scene()
    markerGroup.add(markerScene)

    var ambientLight = new THREE.AmbientLight( 0xcccccc, 0.4 );
    markerScene.add( ambientLight );


    new THREE.MTLLoader()
    .setPath( './assets/' )
    .load( '3d-model.mtl', function ( materials ) {
      materials.preload();
      new THREE.OBJLoader()
        .setMaterials( materials )
        .setPath( './assets/' )
        .load( '3d-model.obj', function ( object ) {
          // object.position.y = - 95;
          object.scale.x = 0.1
          object.scale.y = 0.1
          object.scale.z = 0.1
          object.rotation.x = Math.PI/2
          object.rotation.y = Math.PI
          object.rotation.z = Math.PI/2
          object.position.x -= 1.5
          // object.position.y += 0.01

          markerScene.add( object );
        }, function ( xhr ) { }, function ( xhr ) { } );
    } );

    var geometry = new THREE.PlaneGeometry( 6000/1500, 2550/1500, 1, 1 );
    var material = new THREE.MeshBasicMaterial({
      map:THREE.ImageUtils.loadTexture('assets/1.jpg'),
      side: THREE.DoubleSide,
      opacity: 0.9,
    });
    var plane = new THREE.Mesh( geometry, material );
    plane.rotation.x = Math.PI/2
    plane.rotation.z = Math.PI/2
    plane.position.y += 0.2
    markerScene.add( plane );

    var raycaster = new THREE.Raycaster(camera.position, camera.getWorldDirection());
    onRenderFcts.push(function(){
      var intersects = raycaster.intersectObjects([plane]);
      if (intersects && intersects.length>0) {
        $(".title:first")[0].innerHTML="Awesome art by Liam!";
      } else $(".title:first")[0].innerHTML="...";
    })

    //////////////////////////////////////////////////////////////////////////////////
    //		render the whole thing on the page
    //////////////////////////////////////////////////////////////////////////////////
    // render the scene
    onRenderFcts.push(function(){
    	renderer.render( scene, camera );
    })
    // run the rendering loop
    var lastTimeMsec= null
    requestAnimationFrame(function animate(nowMsec){
    	// keep looping
    	requestAnimationFrame( animate );
    	// measure time
    	lastTimeMsec	= lastTimeMsec || nowMsec-1000/60
    	var deltaMsec	= Math.min(200, nowMsec - lastTimeMsec)
    	lastTimeMsec	= nowMsec
    	// call each update function
    	onRenderFcts.forEach(function(onRenderFct){
    		onRenderFct(deltaMsec/1000, nowMsec/1000)
    	})
    })
  </script>

  <script async>
  if ('serviceWorker' in navigator) {
    console.log("Will the service worker register?");
    navigator.serviceWorker.register('scripts/service-worker.js')
      .then(function (reg) {
        console.log("Yes, it did.");
      }).catch(function (err) {
        console.log("No it didn't. This happened: ", err)
      });
  }
  </script>

  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-118805418-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-118805418-1');
  </script>
  <noscript>
    Javascript is required to run this app!
  </noscript>


</body>

</html>
